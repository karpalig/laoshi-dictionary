# СЛЕПОК ПРИЛОЖЕНИЯ: Китайско-русский словарь PWA

## ОПИСАНИЕ ПРОЕКТА

Progressive Web App (PWA) - китайско-русский словарь с использованием Framework7 (iOS theme), IndexedDB для хранения данных, и поддержкой темной/светлой темы.

**Основные функции:**
- Поиск слов по китайским иероглифам, пиньинь (с тонами и без), русскому переводу
- Управление множественными словарями (источники данных: CEDICT, BKRS)
- Импорт/экспорт списков в JSON, CSV, TXT
- Офлайн работа через Service Worker
- Адаптивный дизайн для мобильных и десктопов

---

## ТЕХНОЛОГИЧЕСКИЙ СТЕК

- **Frontend Framework**: Framework7 v9.0.2 (iOS Glass theme) 
  - npm install framework7
- **Icons**: Framework7 Icons
- **Storage**: IndexedDB (браузерная база данных, локальное хранение)
- **PWA**: Service Worker для офлайн работы
- **Языки**: Vanilla JavaScript (ES6+), HTML5, CSS3
- **Шрифты**: Noto Sans SC для китайских символов

---

## СТРУКТУРА ПРОЕКТА

```
laoshi-dictionary/

├── manifest.json           # PWA манифест
├── sw.js                   # Service Worker для кэширования
├── package.json            # NPM зависимости
├── js/
│   ├── app.js              # Основная логика приложения (~1500 строк)
│   ├── db.js               # IndexedDB менеджер (~280 строк)
│   └── pinyin.js           # Утилиты для работы с пиньинь (~110 строк)
└── dictionary/             # Примеры словарей для импорта
    ├── sys/                # Папка системных deck (списков)
    ├── index.json          # Индекс доступных словарей
    └── [*.json, *.csv, *.txt файлы словарей]
```

---

## ОСНОВНЫЕ ФАЙЛЫ

| Файл | Назначение |
|------|------------|
| `index.html` | Главная страница, регистрация Service Worker, структура Framework7 (views, pages, navbar, tabbar) |
| `direct.html` | Версия для разработки без Service Worker |
| `manifest.json` | PWA манифест для установки как приложение |
| `sw.js` | Service Worker: кэширование HTML, CSS, JS, manifest, примеры словарей |
| `js/db.js` | IndexedDB менеджер: CRUD операции, миграции БД |
| `js/pinyin.js` | Конвертация тонов (ni3 → nǐ), нормализация для поиска, цвета HSK |

---

## СТРУКТУРА БАЗЫ ДАННЫХ (IndexedDB)

### Концепция

**Dictionary (словарь)** = источник данных (CEDICT, BKRS)
- Хранилище всех слов (одно или несколько источников)
- Каждое слово уникально в рамках источника
- Для BKRS: форматированный текст (теги) парсится и выводится как статья + нужен обработчик фронтенда

**Deck (коллекция/фильтр)** = пользовательская группировка
- HSK 1, HSK 2, "Ресторан", "Путешествия" - это фильтры/теги
- Одно слово может быть в нескольких decks
- Favorites - это тоже deck (системный, `isFavorites: true`)

### Схема БД (5 таблиц) хранятся в формате .ndjson

1. dictionary (Основной массив БКРС)
Самый тяжелый файл, используем однобуквенные ключи.
{
  "w": "猫眼",          // word (Primary Key)
  "p": "mao1yan3",      // pinyin (Index)
  "h": 0,              // hsk_level (Index)
  "d": [               // definitions (Array)
    "1) кошачий глаз",
    "2) дверной глазок"
  ]
}

2. sentences (База примеров) - пользователь может добавить пример к любому слову
Файл: sentences.json. 
{
  "id": "s1",          // Primary Key
  "r": "猫眼",          // word_ref (Index)
  "z": "他在猫眼里看了一下", // zh_sentence
  "p": "ta1 zai4 mao1yan3 li3 kan4 le0 yi1xia4", // pinyin_sentence
  "t": "Он заглянул в дверной глазок."  // translation
}


3. user_data (Личное: заметки и свои примеры)
Файл: user.json. Здесь храним то, что ввел сам пользователь.
JSON
{
  "id": "u1",          // Primary Key
  "r": "猫眼",          // word_ref (Index)
  "type": "note",      // 'note' или 'sentence'
  "c": "Купил в Пекине", // content
  "p": "",             // pinyin (если это свой пример)
  "ts": 1704278400     // timestamp
}

4. decks (Метаданные списков)
Файл: decks.json. Описания папок/колод.
JSON
{
  "deck_info": {
    "id": "hsk_1",
    "name": "HSK 1", // подобныйх будет 7 списков
    "type": "sys",
    "description": "Базовый уровень (150 слов)",
    "c": "#FF0000",       // color_tag
    "order": 1,
  },
  "items": [
    {
"id": "L1-0001"
      "w": "爱",
      "p": "ai4",
      "d": "любовь",
      "radicals": "爫",
      "strokes": "10",
      }
    }
  ]
}
5. deck_words (Содержимое списков / Карточки)
Автономная запись для мгновенной отрисовки списка.
JSON
{
  "id": "dw1",         // Primary Key
  "did": "hsk_1",      // deck_id (Index)
  "r": "你好",          // word_ref (Index)
  "w": "你好",          // word_cache
  "p": "nǐ hǎo",       // pinyin_cache
  "m": "Привет",       // meaning (конкретное значение)
  "s": "你好吗？",      // sentence_cache (короткий пример для списка)
  "sp": "nǐ hǎo ma?"   // sentence_pinyin_cache
}
---

## ФУНКЦИОНАЛЬНОСТЬ

### Поиск
- Многоязычный: китайские иероглифы, пиньинь (с тонами и без), русский перевод
- Нормализация пиньинь (удаление тонов для поиска)
- Регистронезависимый
- Результаты в реальном времени

### Управление списками
- Создание множественных списков 
- Редактирование названия и описания
- Выбор цвета для визуальной идентификации
- Активация/деактивация
- Удаление (с каскадным удалением связанных данных)

### Управление словами
- Добавление слов с китайским, пиньинь, русским, пример, пиньинь для примера
- HSK уровни (1-6) - отдельная таблица, синхронизация по тексту
- Избранное - через decks (системный deck `isFavorites: true`)
- Поиск по всем полям
- Удаление слов

### Примеры
- Базовые примеры (из словаря)
- Пользовательские примеры
- Предложения на китайском, пиньинь, русский перевод
- Привязка к словам

### Импорт/Экспорт

**Импорт:**
- **NDJSON**: полный формат со всеми данными (dictionary, words, examples, decks)
- **CSV**: разделитель `;`, колонки `word;pinyin;russian;hsk`, первая строка - заголовок
- **TXT**: разделитель `|`, формат `word | pinyin | russian | hsk`, одна строка = одно слово
- Автоматическое создание dictionary и deck при импорте

**Экспорт:**
- Экспорт пользовательских данных

---

## UI СТРУКТУРА (Framework7)

### Навигация
- **Bottom tabbar**: Поиск, Списки, Настройки
- **Navbar**: заголовок страницы

### Страницы

**Поиск:**
- по умолчанию загрузить основной словарь
- Empty state отображается история запросов, если нет истории то название загруженного словаря
- Поле поиска (Framework7 searchbar)
- Результаты поиска (список слов с Framework7: list media-list list-outline-ios list-strong-ios list-dividers-ios) отложенная загрузка

**Списки:**
- Предустановленные Списки: HSK 1 "dictionary\hsk-ru" (список слов с Framework7: list media-list list-outline-ios list-strong-ios list-dividers-ios)
- Создание пользовательских списков 
- Кнопки в navbar: добавить
- Внутри списков (Framework7 Virtual List Layout)


**Настройки**
- userpic, name
- список настроек с Framework7: list media-list list-outline-ios list-strong-ios list-dividers-ios
  - toggle ночная тема
  - выбрать словарь

### Модальные окна
- Framework7 Popup: push view для всех модальных окон
- Формы создания/редактирования словаря
- Формы импорта
- Детали слова (с форматированием BKRS если есть)
- Детали словаря

---

## ОСОБЕННОСТИ РЕАЛИЗАЦИИ

### Framework7
- **Только стандартные классы** - никаких кастомных CSS классов для UI компонентов
- Светлая тема по умолчанию (`darkMode: false`)
- Переключение темной/светлой темы через localStorage
- Использование стандартных Framework7 цветов и тем

### IndexedDB
- Браузерная NoSQL база данных (локальное хранение)
- Автоматическое создание схемы БД при первом запуске
- Миграции через `onupgradeneeded`
- Инициализация после пользовательского действия (требование IndexedDB)

### Pinyin обработка
- Автоматическая конвертация номеров тонов в тоновые знаки (ni3 → nǐ)
- Нормализация для поиска (удаление всех тонов)
- Правила размещения тоновых знаков (a/e имеют приоритет)
- Цвета для уровней HSK

### PWA (Service Worker)
- Кэширование статических ресурсов (HTML, CSS, JS, manifest)
- Кэширование примеров словарей
- Офлайн работа после первой загрузки
- Работает только на HTTP(S), не работает с file:// протоколом

### Производительность
- Ленивая загрузка данных
- Кэширование через Service Worker
- Оптимизированный поиск (фильтрация в памяти)
- Индексы в IndexedDB для быстрого поиска

### Безопасность
- Все данные локальные (IndexedDB)
- Нет отправки данных на сервер
- Нет аналитики или трекинга
- Полная приватность

---

## КРИТИЧЕСКИ ВАЖНО

1. **Все пути к файлам относительные** - структура папок должна быть точной
2. **Framework7 файлы в lib/** - не использовать CDN, файлы должны быть локальными и закоммичены
3. **Порядок загрузки скриптов:** `pinyin.js` → `db.js` → `app.js`
4. **Service Worker работает только на HTTP(S)** - не работает с file:// протоколом
5. **IndexedDB требует пользовательского действия** - инициализация после клика пользователя
6. **Только стандартные Framework7 классы** - никаких кастомных стилей для UI компонентов
7. **Светлая тема по умолчанию** - `darkMode: false` при инициализации Framework7

---

### Стэк 

https://github.com/framework7io/framework7
https://github.com/framework7io/rollup-plugin-framework7
https://github.com/jakearchibald/idb
https://github.com/nextapps-de/flexsearch?tab=readme-ov-file
---